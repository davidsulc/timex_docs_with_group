<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.19.1">
    <title>Custom Parsers – timex v3.4.1</title>
    <link rel="stylesheet" href="dist/html-4f6aa19597cd1982c84e.css" />
    <script src="dist/sidebar_items-b670025c07.js"></script>
    
  </head>
  <body data-type="extras">
    <script>try { if(localStorage.getItem('night-mode')) document.body.className += ' night-mode'; } catch (e) { }</script>
<div class="main">
<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" aria-hidden="true"></span>
  <span class="sr-only">Toggle Sidebar</span>
</button>
<button class="sidebar-button night-mode-toggle">
  <span class="icon-theme" aria-hidden="true"></span>
  <span class="sr-only">Toggle Theme</span>
</button>
<section class="sidebar">

  <a href="getting-started.html" class="sidebar-projectLink">
    <div class="sidebar-projectDetails">
      <h1 class="sidebar-projectName">
timex      </h1>
      <h2 class="sidebar-projectVersion">
        v3.4.1
      </h2>
    </div>
  </a>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
    <input name="q" type="text" id="search-list" class="search-input" placeholder="Search" aria-label="Search" autocomplete="off" />
  </form>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">Pages</a></li>

      <li><a id="modules-list" href="#full-list">Modules</a></li>

      <li><a id="exceptions-list" href="#full-list">Exceptions</a></li>

  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">


<h1>Custom Parsers</h1>
<h3 id="how-to-add-custom-datetime-parsers-to-timex" class="section-heading">
  <a href="#how-to-add-custom-datetime-parsers-to-timex" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  How to add custom DateTime parsers to Timex
</h3>

<p>It is unlikely you will need to write a custom parser for Timex, but should you be in such a position, you can easily plug in your own without much trouble.</p>
<h2 id="getting-started" class="section-heading">
  <a href="#getting-started" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Getting Started
</h2>

<p>In brief, all you need to know is the following:</p>
<ul>
<li>Extend the <code class="inline">Tokenizer</code> behavior, by adding <code class="inline">use Timex.Parse.DateTime.Tokenizer</code> to the top of your module.
</li>
<li>Implement <code class="inline">tokenize/1</code> callback.
</li>
<li>Implement <a href="https://hexdocs.pm/elixir/Kernel.html#apply/3"><code class="inline">apply/3</code></a> callback.
</li>
</ul>
<p>What we are doing with the above is implementing a tokenizer for the format strings your custom parser will use. Incidentally this also is a prerequisite for implementing a custom formatter (you need to tokenize the format strings). Your best reference is to look at the two built-in tokenizers in Timex, as they are robust and complete implementations, but for the sake of an arbitrary example, let’s walk through implementing a very simple parser for humanized strings like “5 days before the fifth of July, 2015”, where the following tokens are allowed:</p>
<ul>
<li>“{shift}” which should be in the form of “<integer> <unit> <before | after>“
</li>
<li>“{day}” of the form “first”, “second”, “third”, etc.
</li>
<li>“{month}” which is the full name of a month, i.e. “July”
</li>
<li>“{year}” which is the full four digit year
</li>
</ul>
<h2 id="tokenizer-implementation" class="section-heading">
  <a href="#tokenizer-implementation" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Tokenizer Implementation
</h2>

<h3 id="implementing-the-humanized-tokenizer" class="section-heading">
  <a href="#implementing-the-humanized-tokenizer" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Implementing the Humanized tokenizer
</h3>

<p>We start by defining our empty module:</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.DateTimeTokenizers.Humanized</span><span class="w"> </span><span class="k" data-group-id="3777551472-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Timex.Parse.DateTime.Tokenizer</span><span class="w">
</span><span class="k" data-group-id="3777551472-1">end</span></code></pre>
<p>Compiling with this will produce the following errors:</p>
<pre><code class="nohighlight makeup elixir"><span class="o">.</span><span class="o">.</span><span class="o">/</span><span class="n">humanized</span><span class="o">.</span><span class="n">ex</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="ss">warning</span><span class="p">:</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="n">behaviour</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">tokenize</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p" data-group-id="6853293581-1">(</span><span class="k">for</span><span class="w"> </span><span class="n">behaviour</span><span class="w"> </span><span class="nc">Timex.Parse.DateTime.Tokenizer</span><span class="p" data-group-id="6853293581-1">)</span><span class="w">
</span><span class="o">.</span><span class="o">.</span><span class="o">/</span><span class="n">humanized</span><span class="o">.</span><span class="n">ex</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="ss">warning</span><span class="p">:</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="n">behaviour</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">apply</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p" data-group-id="6853293581-2">(</span><span class="k">for</span><span class="w"> </span><span class="n">behaviour</span><span class="w"> </span><span class="nc">Timex.Parse.DateTime.Tokenizer</span><span class="p" data-group-id="6853293581-2">)</span></code></pre>
<p>So we need to implement the <code class="inline">tokenize</code> function which takes a format string and produces a list of <code class="inline">Directive</code> structs (or <code class="inline">{:error, term}</code>). The following implementation makes use of Combine, a dependency pulled in by Timex for parsing tasks, and while you do not need to implement your tokenizer using Combine, the parser function given to each Directive must take a single argument of <code class="inline">%Combine.ParserState{}</code>, and return it, updated with the status and results from parsing. See <a href="https://github.com/bitwalker/combine">the Combine repo</a> for examples on how to implement these parsers (it is really rather trivial). My recommendation is to simply use Combine, as it is well suited for these tasks, but now you know how to work around it if so desired.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.DateTimeTokenizers.Humanized</span><span class="w"> </span><span class="k" data-group-id="2762515914-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Timex.Parse.DateTime.Tokenizer</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Combine</span><span class="w">

  </span><span class="na">@days</span><span class="w"> </span><span class="p" data-group-id="2762515914-2">[</span><span class="w">
    </span><span class="s">&quot;first&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;second&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;third&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fourth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fifth&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;sixth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;seventh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eighth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ninth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tenth&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;eleventh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twelfth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;thirteenth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fourteenth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fifteenth&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;sixteenth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;seventeenth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eighteenth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nineteenth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twentieth&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;twenty-first&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twenty-second&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twenty-third&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twenty-fourth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twenty-fifth&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;twenty-sixth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twenty-seventh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twenty-eighth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;twenty-ninth&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;thirtieth&quot;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;thirty-first&quot;</span><span class="w">
  </span><span class="p" data-group-id="2762515914-2">]</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">tokenize</span><span class="p" data-group-id="2762515914-3">(</span><span class="n">s</span><span class="p" data-group-id="2762515914-3">)</span><span class="w"> </span><span class="k" data-group-id="2762515914-4">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Combine</span><span class="o">.</span><span class="n">parse</span><span class="p" data-group-id="2762515914-5">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p" data-group-id="2762515914-5">)</span><span class="w"> </span><span class="k" data-group-id="2762515914-6">do</span><span class="w">
      </span><span class="n">results</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_list</span><span class="p" data-group-id="2762515914-7">(</span><span class="n">results</span><span class="p" data-group-id="2762515914-7">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">directives</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">flatten</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="2762515914-8">(</span><span class="k" data-group-id="2762515914-9">fn</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="k" data-group-id="2762515914-9">end</span><span class="p" data-group-id="2762515914-8">)</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">any?</span><span class="p" data-group-id="2762515914-10">(</span><span class="n">directives</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2762515914-11">fn</span><span class="w"> </span><span class="p" data-group-id="2762515914-12">%</span><span class="nc" data-group-id="2762515914-12">Directive</span><span class="p" data-group-id="2762515914-12">{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="n">type</span><span class="p" data-group-id="2762515914-12">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:literal</span><span class="w"> </span><span class="k" data-group-id="2762515914-11">end</span><span class="p" data-group-id="2762515914-10">)</span><span class="w"> </span><span class="k" data-group-id="2762515914-13">do</span><span class="w">
          </span><span class="no">false</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2762515914-14">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid format string, must contain at least one directive.&quot;</span><span class="p" data-group-id="2762515914-14">}</span><span class="w">
          </span><span class="no">true</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2762515914-15">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">directives</span><span class="p" data-group-id="2762515914-15">}</span><span class="w">
        </span><span class="k" data-group-id="2762515914-13">end</span><span class="w">
      </span><span class="p" data-group-id="2762515914-16">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="2762515914-16">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">err</span><span class="w">
    </span><span class="k" data-group-id="2762515914-6">end</span><span class="w">
  </span><span class="k" data-group-id="2762515914-4">end</span><span class="w">

  </span><span class="c1"># Token parser</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">parser</span><span class="w"> </span><span class="k" data-group-id="2762515914-17">do</span><span class="w">
    </span><span class="n">many1</span><span class="p" data-group-id="2762515914-18">(</span><span class="n">choice</span><span class="p" data-group-id="2762515914-19">(</span><span class="p" data-group-id="2762515914-20">[</span><span class="w">
      </span><span class="n">between</span><span class="p" data-group-id="2762515914-21">(</span><span class="n">char</span><span class="p" data-group-id="2762515914-22">(</span><span class="sc">?{</span><span class="p" data-group-id="2762515914-22">)</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p" data-group-id="2762515914-23">(</span><span class="n">one_of</span><span class="p" data-group-id="2762515914-24">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2762515914-25">[</span><span class="s">&quot;shift&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;day&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;month&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;year&quot;</span><span class="p" data-group-id="2762515914-25">]</span><span class="p" data-group-id="2762515914-24">)</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">map_directive</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="2762515914-23">)</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="2762515914-26">(</span><span class="sc">?}</span><span class="p" data-group-id="2762515914-26">)</span><span class="p" data-group-id="2762515914-21">)</span><span class="p">,</span><span class="w">
      </span><span class="n">map</span><span class="p" data-group-id="2762515914-27">(</span><span class="n">none_of</span><span class="p" data-group-id="2762515914-28">(</span><span class="n">char</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2762515914-29">[</span><span class="s">&quot;{&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;}&quot;</span><span class="p" data-group-id="2762515914-29">]</span><span class="p" data-group-id="2762515914-28">)</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">map_literal</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="2762515914-27">)</span><span class="w">
    </span><span class="p" data-group-id="2762515914-20">]</span><span class="p" data-group-id="2762515914-19">)</span><span class="p" data-group-id="2762515914-18">)</span><span class="w">
  </span><span class="k" data-group-id="2762515914-17">end</span><span class="w">

  </span><span class="c1"># Gets/builds the Directives for a given token</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">map_directive</span><span class="p" data-group-id="2762515914-30">(</span><span class="s">&quot;year&quot;</span><span class="p" data-group-id="2762515914-30">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Directive</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="2762515914-31">(</span><span class="ss">:year4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;year&quot;</span><span class="p" data-group-id="2762515914-31">)</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">map_directive</span><span class="p" data-group-id="2762515914-32">(</span><span class="s">&quot;month&quot;</span><span class="p" data-group-id="2762515914-32">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Directive</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="2762515914-33">(</span><span class="ss">:mfull</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;month&quot;</span><span class="p" data-group-id="2762515914-33">)</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">map_directive</span><span class="p" data-group-id="2762515914-34">(</span><span class="s">&quot;day&quot;</span><span class="p" data-group-id="2762515914-34">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2762515914-35">%</span><span class="nc" data-group-id="2762515914-35">Directive</span><span class="p" data-group-id="2762515914-35">{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:oday_phonetic</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;day&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">parser</span><span class="p">:</span><span class="w"> </span><span class="n">oday_phoenetic_parser</span><span class="p" data-group-id="2762515914-36">(</span><span class="p" data-group-id="2762515914-36">)</span><span class="p" data-group-id="2762515914-35">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">map_directive</span><span class="p" data-group-id="2762515914-37">(</span><span class="s">&quot;shift&quot;</span><span class="p" data-group-id="2762515914-37">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2762515914-38">%</span><span class="nc" data-group-id="2762515914-38">Directive</span><span class="p" data-group-id="2762515914-38">{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:date_shift</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;shift&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">parser</span><span class="p">:</span><span class="w"> </span><span class="n">date_shift_parser</span><span class="p" data-group-id="2762515914-39">(</span><span class="p" data-group-id="2762515914-39">)</span><span class="p">,</span><span class="w"> </span><span class="ss">weight</span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="p" data-group-id="2762515914-38">}</span><span class="w">

  </span><span class="c1"># Generates directives for literals</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">map_literal</span><span class="p" data-group-id="2762515914-40">(</span><span class="p" data-group-id="2762515914-41">[</span><span class="p" data-group-id="2762515914-41">]</span><span class="p" data-group-id="2762515914-40">)</span><span class="p">,</span><span class="w">        </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">map_literal</span><span class="p" data-group-id="2762515914-42">(</span><span class="n">literals</span><span class="p" data-group-id="2762515914-42">)</span><span class="w">
    </span><span class="ow">when</span><span class="w"> </span><span class="n">is_list</span><span class="p" data-group-id="2762515914-43">(</span><span class="n">literals</span><span class="p" data-group-id="2762515914-43">)</span><span class="p">,</span><span class="w">    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="2762515914-44">(</span><span class="n">literals</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">map_literal</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="2762515914-44">)</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">map_literal</span><span class="p" data-group-id="2762515914-45">(</span><span class="n">literal</span><span class="p" data-group-id="2762515914-45">)</span><span class="p">,</span><span class="w">   </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2762515914-46">%</span><span class="nc" data-group-id="2762515914-46">Directive</span><span class="p" data-group-id="2762515914-46">{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:literal</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="n">literal</span><span class="p">,</span><span class="w"> </span><span class="ss">parser</span><span class="p">:</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="2762515914-47">(</span><span class="n">literal</span><span class="p" data-group-id="2762515914-47">)</span><span class="p" data-group-id="2762515914-46">}</span><span class="w">

  </span><span class="c1"># Parses a phonetic ordinal day string, i.e. third</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">oday_phoenetic_parser</span><span class="p" data-group-id="2762515914-48">(</span><span class="p" data-group-id="2762515914-48">)</span><span class="w"> </span><span class="k" data-group-id="2762515914-49">do</span><span class="w">
    </span><span class="n">map</span><span class="p" data-group-id="2762515914-50">(</span><span class="n">one_of</span><span class="p" data-group-id="2762515914-51">(</span><span class="n">word_of</span><span class="p" data-group-id="2762515914-52">(</span><span class="sr">~r/[</span><span class="se">\w</span><span class="se">\-</span><span class="sr">]/</span><span class="p" data-group-id="2762515914-52">)</span><span class="p">,</span><span class="w"> </span><span class="na">@days</span><span class="p" data-group-id="2762515914-51">)</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2762515914-53">fn</span><span class="w"> </span><span class="n">day</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2762515914-54">[</span><span class="ss">day</span><span class="p">:</span><span class="w"> </span><span class="n">to_day</span><span class="p" data-group-id="2762515914-55">(</span><span class="n">day</span><span class="p" data-group-id="2762515914-55">)</span><span class="p" data-group-id="2762515914-54">]</span><span class="w"> </span><span class="k" data-group-id="2762515914-53">end</span><span class="p" data-group-id="2762515914-50">)</span><span class="w">
  </span><span class="k" data-group-id="2762515914-49">end</span><span class="w">

  </span><span class="c1"># Parses a date shift expression, i.e. 3 days after</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">date_shift_parser</span><span class="p" data-group-id="2762515914-56">(</span><span class="p" data-group-id="2762515914-56">)</span><span class="w"> </span><span class="k" data-group-id="2762515914-57">do</span><span class="w">
    </span><span class="n">map</span><span class="p" data-group-id="2762515914-58">(</span><span class="n">sequence</span><span class="p" data-group-id="2762515914-59">(</span><span class="p" data-group-id="2762515914-60">[</span><span class="w">
      </span><span class="n">integer</span><span class="p">,</span><span class="w">
      </span><span class="n">skip</span><span class="p" data-group-id="2762515914-61">(</span><span class="n">spaces</span><span class="p" data-group-id="2762515914-61">)</span><span class="p">,</span><span class="w">
      </span><span class="n">one_of</span><span class="p" data-group-id="2762515914-62">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2762515914-63">[</span><span class="s">&quot;seconds&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;minutes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;days&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;months&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;years&quot;</span><span class="p" data-group-id="2762515914-63">]</span><span class="p" data-group-id="2762515914-62">)</span><span class="p">,</span><span class="w">
      </span><span class="n">skip</span><span class="p" data-group-id="2762515914-64">(</span><span class="n">spaces</span><span class="p" data-group-id="2762515914-64">)</span><span class="p">,</span><span class="w">
      </span><span class="n">one_of</span><span class="p" data-group-id="2762515914-65">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2762515914-66">[</span><span class="s">&quot;before&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;after&quot;</span><span class="p" data-group-id="2762515914-66">]</span><span class="p" data-group-id="2762515914-65">)</span><span class="w">
    </span><span class="p" data-group-id="2762515914-60">]</span><span class="p" data-group-id="2762515914-59">)</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2762515914-67">fn</span><span class="w">
      </span><span class="p" data-group-id="2762515914-68">[</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;before&quot;</span><span class="p" data-group-id="2762515914-68">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2762515914-69">[</span><span class="ss">date_shift</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2762515914-70">[</span><span class="p" data-group-id="2762515914-71">{</span><span class="n">to_shift</span><span class="p" data-group-id="2762515914-72">(</span><span class="n">shift</span><span class="p" data-group-id="2762515914-72">)</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="p" data-group-id="2762515914-71">}</span><span class="p" data-group-id="2762515914-70">]</span><span class="p" data-group-id="2762515914-69">]</span><span class="w">
      </span><span class="p" data-group-id="2762515914-73">[</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;after&quot;</span><span class="p" data-group-id="2762515914-73">]</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2762515914-74">[</span><span class="ss">date_shift</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2762515914-75">[</span><span class="p" data-group-id="2762515914-76">{</span><span class="n">to_shift</span><span class="p" data-group-id="2762515914-77">(</span><span class="n">shift</span><span class="p" data-group-id="2762515914-77">)</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p" data-group-id="2762515914-76">}</span><span class="p" data-group-id="2762515914-75">]</span><span class="p" data-group-id="2762515914-74">]</span><span class="w">
    </span><span class="k" data-group-id="2762515914-67">end</span><span class="p" data-group-id="2762515914-58">)</span><span class="w">
  </span><span class="k" data-group-id="2762515914-57">end</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">to_shift</span><span class="p" data-group-id="2762515914-78">(</span><span class="n">shift</span><span class="p" data-group-id="2762515914-78">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_atom</span><span class="p" data-group-id="2762515914-79">(</span><span class="n">shift</span><span class="p" data-group-id="2762515914-79">)</span><span class="w">

  </span><span class="c1"># Get the ordinal day value based on the ordinal day name</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">to_day</span><span class="p" data-group-id="2762515914-80">(</span><span class="n">name</span><span class="p" data-group-id="2762515914-80">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">find_index</span><span class="p" data-group-id="2762515914-81">(</span><span class="na">@days</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2762515914-82">fn</span><span class="w"> </span><span class="p" data-group-id="2762515914-83">(</span><span class="n">n</span><span class="p" data-group-id="2762515914-83">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k" data-group-id="2762515914-82">end</span><span class="p" data-group-id="2762515914-81">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="k" data-group-id="2762515914-1">end</span></code></pre>
<h2 id="implementation-notes" class="section-heading">
  <a href="#implementation-notes" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Implementation Notes
</h2>

<p>A couple of things to notice.</p>
<ol>
<li>Many parsing directives are already built in to Timex, you can see which ones exist by looking at the <code class="inline">Directive</code> module. Rather than re-implement parsing of month names and 4 digit years, we’re using <code class="inline">Directive.get</code> to pull the predefined Directives for those.
</li>
<li>However we also have two custom directives to handle the phonetic ordinal names and the date shift expressions, we’re defining those directives (and their associated parsers) by hand. This is also the reason why you must implement <a href="https://hexdocs.pm/elixir/Kernel.html#apply/3"><code class="inline">apply/3</code></a>. The built-in directives are applied via the parser, but custom tokens have to be applied by the tokenizer. I could have split out the tokenize and apply functions into two behaviours (say Tokenizer and Parser), but rather than force that upon you, this is a decision you can make in your own tokenizer (by using defdelegate to keep your <a href="https://hexdocs.pm/elixir/Kernel.html#apply/3"><code class="inline">apply/3</code></a> code separated).
</li>
<li>We’re creating Directive structs for literal characters. This is important both for parsing and formatting, as it allows your parser to ignore context (i.e. skipping spaces, etc.) and focus on parsing the precise thing it needs to parse. When formatting it’s also important, as it makes sure that we output a string which matches the format string precisely.
</li>
<li>The parsers for the directives return a keyword list of <code class="inline">token: value</code> as their result. This is a requirement, as the parser will take the input string and parse out a flattened list of <code class="inline">{token, value}</code> tuples. If your directive parsers do not produce values in this form, they will be ignored, and thus your parser will not work properly (and will likely produce an error).
</li>
<li>We’re setting the <code class="inline">weight</code> key of the Directive for the shift expression. This will ensure that it is applied last. Consider the input string “3 days after July fourth, 2015”, if we try to apply the shift expression to the DateTime we get in <a href="https://hexdocs.pm/elixir/Kernel.html#apply/3"><code class="inline">apply/3</code></a> (which starts at <code class="inline">0/1/1T00:00:00</code>), we will get an error for trying to shift the date out of the gregorian calendar, when really we want to apply the shift to the date specified later in the input string. By weighting the directive to be last, we will first apply the month, then the day, then the year to the initial DateTime, then apply the shift to the date we actually wanted it applied to. You can set the weight for all your directives to have them applied in a specific order, so keep it in mind for situations like this.
</li>
</ol>
<p>We are left now with the responsibility of implementing <a href="https://hexdocs.pm/elixir/Kernel.html#apply/3"><code class="inline">apply/3</code></a>, leaving our tokenizer implementation looking like the following:</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.DateTimeTokenizers.Humanized</span><span class="w"> </span><span class="k" data-group-id="2918397074-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Timex.Parse.DateTime.Tokenizer</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Combine</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Timex.Date</span><span class="w">

  </span><span class="n">...</span><span class="n">snip</span><span class="n">...</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Applies a token to the DateTime representing the current input string
  Only unrecognized tokens are applied via this function, standard tokens,
  such as :year4 will be handled by the parser itself.

  You can return {:ok, date}, {:error, reason}, or :unrecognized (if you don&#39;t
  know what to do with the provided token).
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">apply</span><span class="p" data-group-id="2918397074-2">(</span><span class="p" data-group-id="2918397074-3">%</span><span class="nc" data-group-id="2918397074-3">DateTime</span><span class="p" data-group-id="2918397074-3">{</span><span class="p" data-group-id="2918397074-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p" data-group-id="2918397074-2">)</span><span class="w"> </span><span class="k" data-group-id="2918397074-4">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k" data-group-id="2918397074-5">do</span><span class="w">
      </span><span class="ss">:oday_phonetic</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="2918397074-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2918397074-7">%{</span><span class="n">date</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:day</span><span class="w"> </span><span class="o">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">value</span><span class="p" data-group-id="2918397074-7">}</span><span class="p" data-group-id="2918397074-6">}</span><span class="w">
      </span><span class="ss">:date_shift</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k" data-group-id="2918397074-8">do</span><span class="w">
          </span><span class="p" data-group-id="2918397074-9">[</span><span class="p" data-group-id="2918397074-10">{</span><span class="n">shift</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p" data-group-id="2918397074-10">}</span><span class="p" data-group-id="2918397074-9">]</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_integer</span><span class="p" data-group-id="2918397074-11">(</span><span class="n">n</span><span class="p" data-group-id="2918397074-11">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2918397074-12">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">Timex</span><span class="o">.</span><span class="n">shift</span><span class="p" data-group-id="2918397074-13">(</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2918397074-14">[</span><span class="p" data-group-id="2918397074-15">{</span><span class="n">shift</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p" data-group-id="2918397074-15">}</span><span class="p" data-group-id="2918397074-14">]</span><span class="p" data-group-id="2918397074-13">)</span><span class="p" data-group-id="2918397074-12">}</span><span class="w">
          </span><span class="n">shift</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2918397074-16">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unrecognized shift operation: </span><span class="si" data-group-id="2918397074-17">#{</span><span class="nc">Macro</span><span class="o">.</span><span class="n">to_string</span><span class="p" data-group-id="2918397074-18">(</span><span class="n">shift</span><span class="p" data-group-id="2918397074-18">)</span><span class="si" data-group-id="2918397074-17">}</span><span class="s">&quot;</span><span class="p" data-group-id="2918397074-16">}</span><span class="w">
        </span><span class="k" data-group-id="2918397074-8">end</span><span class="w">
      </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="2918397074-19">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unrecognized token: </span><span class="si" data-group-id="2918397074-20">#{</span><span class="n">token</span><span class="si" data-group-id="2918397074-20">}</span><span class="s">.&quot;</span><span class="p" data-group-id="2918397074-19">}</span><span class="w">
    </span><span class="k" data-group-id="2918397074-5">end</span><span class="w">
  </span><span class="k" data-group-id="2918397074-4">end</span><span class="w">

  </span><span class="n">...</span><span class="n">snip</span><span class="n">...</span><span class="w">
</span><span class="k" data-group-id="2918397074-1">end</span></code></pre>
<h2 id="usage" class="section-heading">
  <a href="#usage" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Usage
</h2>

<p>After all this, we’re now ready to use our custom parser!</p>
<pre><code class="nohighlight makeup elixir"><span class="o">&gt;</span><span class="w"> </span><span class="kn">alias</span><span class="w"> </span><span class="nc">MyApp.DateTimeTokenizers.Humanized</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">phrase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;3 days before the second of July, 2015&quot;</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;{shift} the {day} of {month}, {year}&quot;</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Timex</span><span class="o">.</span><span class="n">parse!</span><span class="p" data-group-id="7695340511-1">(</span><span class="n">phrase</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="nc">Humanized</span><span class="p" data-group-id="7695340511-1">)</span><span class="w">
</span><span class="c1">#&lt;DateTime(2015-07-01T00:00:00Z Etc/UTC)&gt;</span></code></pre>
      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.19.1),
          </span>
          <span class="line">
            designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
            </span>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>
  <script src="dist/html-4f6aa19597cd1982c84e.js"></script>
  
  </body>
</html>

